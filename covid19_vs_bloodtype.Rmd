---
title: "A Regression Analysis of Covid19 VS. Blood Type"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

Fetch data from the WHO website

```{r}
whoDataArtifact <- "WHO-COVID-19-global-data.csv"
whoSource <- "https://covid19.who.int"
localDataDir <- "data"
urlEndpoint <- paste(whoSource, whoDataArtifact, sep="/")
filePath <- paste(localDataDir, whoDataArtifact, sep="/")
download.file(urlEndpoint, filePath)

# We need to be careful of Namibia whose 2-letter country code is "NA"
# As it turns out, read.csv by default sets na.strings=c("NA")
# so turn this off with na.strings=c() and mutate to three letter codes before
# joining
whoDataFrame <- read.csv(filePath,na.strings=c())

```
Now that we have the data let's get the latest info.

```{r}
library(dplyr)
library(countrycode)

whoLatestInfo <- whoDataFrame %>%
    mutate(Date_reported=as.Date(Date_reported, format = "%Y-%m-%d"),
           country_code=if_else(Country_code=="XK","XXK", countrycode(Country_code, origin="iso2c", destination="iso3c", nomatch=NULL))) %>%
    group_by(Country_code) %>%
    arrange(Date_reported, by_group=TRUE) %>%
    slice_tail() %>%
  filter(Country != "Other")

```

So now let's get blood type info ...

```{r}
library(RCurl)
library(XML)
library(rlist)
bloodTypesUrl <- "https://en.wikipedia.org/wiki/Blood_type_distribution_by_country"
htmlContent <- getURL(bloodTypesUrl)
tables <- readHTMLTable(htmlContent)
tables <- list.clean(tables, fun = is.null, recursive = FALSE)
bloodTypeDataFrame <- tables[[grep("ABO and Rh blood type distribution", names(tables))]]
```

But we need to clean up this table.
* The first row is the colunn names we'll remove that and replace with clean names.
* The last row is for the world - we don't need that either
* the percentages have % and are scaled by 100 so we need to renormalize.
* The countries have reference brackets - we need to clean those.

```{r}
library(dplyr)
library(countrycode)

bloodTypeCleanup01 <- bloodTypeDataFrame %>%
  slice(-1,-dim(bloodTypeDataFrame```{r}
plot(normalizedDataFrame$D,normalizedDataFrame$case_fatality)
modelD2 <- lm(case_fatality ~ D, data=normalizedDataFrame)
abline(modelD2)

```)[1])
names(bloodTypeCleanup01) <- c("country","population","o+","a+","b+","ab+","o-","a-","b-","ab-")
bloodTypeCleanup02 <- bloodTypeCleanup01 %>%
  mutate(
    country=sub("\\[[0-9]+\\]$","",country),
    population=as.numeric(gsub(D",", "",population))
    ) %>%
  mutate_at(c("o+","a+","b+","ab+","o-","a-","b-","ab-"), ~ as.numeric(sub("%$","", .x)) / 100 ) %>%
  mutate(country_code=countrycode(country, origin="country.name", destination="iso3c"))
  
workingDataFrame <- inner_join(whoLatestInfo, bloodTypeCleanup02, by="country_code")
```

Now let's clean up the table and start building our model. First, we need to normalize the covid statistics by population in cases per 100,000 of population.

```{r}

ck <- 100000
normalizedDataFrame <- workingDataFrame %>%
  mutate(
    cases_per_100k = round(Cumulative_cases / population * ck),
    deaths_per_100k = round(Cumulative_deaths / population * ck),
    A = `o+` + `o-` + `b+` + `b-`,
    B = `o+` + `o-` + `a+` + `a-`,
    D = `o-` + `a-` + `b-`,
    case_fatality = Cumulative_deaths / Cumulative_cases
    )

plot(normalizedDataFrame$A,normalizedDataFrame$cases_per_100k)
modelA <- lm(cases_per_100k ~ A, data=normalizedDataFrame)
abline(modelA)

```

```{r}
plot(normalizedDataFrame$B,normalizedDataFrame$cases_per_100k)
modelB <- lm(cases_per_100k ~ B, data=normalizedDataFrame)
abline(modelB)


```

  
```{r}
plot(normalizedDataFrame$D,normalizedDataFrame$cases_per_100k)
modelD <- lm(cases_per_100k ~ D, data=normalizedDataFrame)
abline(modelD)

```

```{r}
plot(normalizedDataFrame$A,normalizedDataFrame$case_fatality)
modelA2 <- lm(case_fatality ~ A, data=normalizedDataFrame)
abline(modelA2)

```
```{r}
plot(normalizedDataFrame$B,normalizedDataFrame$case_fatality)
modelB2 <- lm(case_fatality ~ B, data=normalizedDataFrame)
abline(modelB2)

```
```{r}
plot(normalizedDataFrame$D,normalizedDataFrame$case_fatality)
modelD2 <- lm(case_fatality ~ D, data=normalizedDataFrame)
abline(modelD2)

```
```{r}
plot(normalizedDataFrame$`o+`,normalizedDataFrame$case_fatality)
modelO2 <- lm(case_fatality ~ `o+`, data=normalizedDataFrame)
abline(modelO2)

```


